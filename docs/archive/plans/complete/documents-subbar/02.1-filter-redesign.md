# Filter Redesign Plan (02.1)

## Status: ✅ COMPLETE (Session 95)

## Summary

Redesign the filter dropdown to use sub-menus and display active filters as pills in the sub-bar.

## Session 95 Completion Notes

All tasks complete with additional polish:
- Tasks 2.1.5-2.1.8 implemented
- Subbar layout reordered: Search → Filter → Pills (Linear-style)
- Filter button icon-only when filters active
- Empty states with ActionButtons and proper icons
- UI polish: checkbox colors, icon alignment, separators removed

## Design Discussion (Session 93)

**Component choice for pills:**
- Considered Badge (shadcn) but it's a non-interactive `span` without dismiss functionality
- Decision: Custom `FilterPill` component in `components/layout/`
- Matches ActionButton styling (`h-7`, `text-xs`) for visual consistency
- See Task 2.1.2 for reference implementation

## Review Summary (Session 93)

**Reviewed by**: frontend-developer agent + code-reviewer agent

**Fixes applied:**
1. ~~Task 2.1.3 removed~~ - server-side `getAllStacks()` was dead code; using client hook instead
2. Task 2.1.4 - Added `stacks` prop interface to FilterButton
3. Task 2.1.7 - Fixed `useStacks` hook to use `useSupabase()` (not non-existent `createBrowserSupabaseClient`)
4. Added pre-implementation step for missing icon exports

**Verdict**: PASS after fixes

## Pre-Implementation: Add Missing Icon Exports

Before starting, add these icons to `frontend/components/icons/index.ts`:

```tsx
export { IconCalendar as Calendar } from '@tabler/icons-react'
export { IconFilterOff as FilterOff } from '@tabler/icons-react'
```

These are used in Task 2.1.4 (dropdown) and Task 2.1.8 (empty state).

## Current State (Phase 2 Complete)

- Filter dropdown with flat structure (date radio group + status checkboxes)
- `activeFilterCount` shown in button label
- Context: `dateRange`, `statusFilter`, `clearFilters()`
- Table filtering via `useMemo` in `documents-table.tsx`

## New Design Requirements

### 1. Sub-Menu Structure (like Theme menu)

```
Filter (dropdown)
├── Date (icon: Calendar) → [sub-menu]
│   ├── All time
│   ├── Today
│   ├── Yesterday
│   ├── Last 7 days
│   └── Last 30 days
│
└── Stacks (icon: Folder) → [sub-menu]
    ├── [Stack 1] (checkbox)
    ├── [Stack 2] (checkbox)
    └── [Stack N] (checkbox)
```

**Pattern Reference**: `sidebar-header-menu.tsx` lines 70-93 (Theme sub-menu)

Uses: `DropdownMenuSub`, `DropdownMenuSubTrigger`, `DropdownMenuSubContent`

### 2. Active Filter Pills in Sub-Bar (Linear-style)

Layout when filters active:
```
[Calendar] 7 days [X]  [Folder] Receipts Q4 [X]  [Folder] Invoices [X]  [≡ Filter icon]
```

- **Pills on left**, filter icon-only button pushed to **right**
- Each filter = individual pill (including each selected stack)
- Short labels: "7 days" not "Last 7 days", "Today" stays "Today"
- Pill structure: `[icon] [value] [X]`
- X removes that specific filter
- Filter button loses text label, becomes icon-only when any filter active

Layout when no filters:
```
[≡ Filter]  (text label visible)
```

### 3. Filter Changes

| Remove | Add |
|--------|-----|
| Status filter (completed, processing, etc.) | Stacks filter (multi-select) |

## Files to Modify

| File | Changes |
|------|---------|
| `filter-button.tsx` | Sub-menu structure, remove status, add stacks |
| `documents-filter-context.tsx` | Remove `statusFilter`, add `stackFilter: Set<string>` |
| `documents-table.tsx` | Update filtering logic for stacks |
| **NEW**: `filter-pill.tsx` | Active filter pill component |
| **NEW**: `filter-bar.tsx` | Filter bar (pills + button) |
| `sub-bar.tsx` or parent | Render filter bar |

## Dependencies

- Need `getAllStacks` query (will pull from Phase 3, Task 6)
- Need stacks data passed to FilterButton

## Implementation Tasks

### Task 2.1.1: Update filter context
- Remove `statusFilter`, `toggleStatusFilter`, `setStatusFilter`
- Add `stackFilter: Set<string>` (stack IDs)
- Add `toggleStackFilter(stackId: string)`
- Update `activeFilterCount` calculation
- Add `clearDateFilter()` and `clearStackFilter(stackId)` for individual clears

**Status filter removal checklist:**

| File | Lines | What to remove |
|------|-------|----------------|
| `documents-filter-context.tsx` | 4 | `import type { DocumentStatus }` |
| `documents-filter-context.tsx` | 23-26 | Type definition (statusFilter, setStatusFilter, toggleStatusFilter) |
| `documents-filter-context.tsx` | 39 | `useState<Set<DocumentStatus>>` |
| `documents-filter-context.tsx` | 53-54 | `setStatusFilter` callback |
| `documents-filter-context.tsx` | 57-64 | `toggleStatusFilter` callback |
| `documents-filter-context.tsx` | 71 | `setStatusFilterState(new Set())` in clearFilters |
| `documents-filter-context.tsx` | 78, 80 | `statusFilter.size` in activeFilterCount |
| `documents-filter-context.tsx` | 89-91, 101-103 | Context value exports |
| `documents-table.tsx` | 48 | Remove `statusFilter` from destructure |
| `documents-table.tsx` | 61-62 | Status filter logic in useMemo |
| `documents-table.tsx` | 66 | `statusFilter` from useMemo deps |
| `filter-button.tsx` | 31-36 | `STATUS_OPTIONS` constant |
| `filter-button.tsx` | 42-43 | Remove from destructure |
| `filter-button.tsx` | 72-83 | Status section (separator + label + checkboxes)

**Note**: Keep `DocumentStatus` type in `types/documents.ts` - it's used for document status display, not just filtering.

**Additional cleanup - document detail sub-bar:**

Remove `<FilterButton />` from `document-detail-sub-bar.tsx` (line 27):
- FilterButton uses `useDocumentsFilter()` (list context)
- Document detail view uses `useDocumentDetailFilter()` (different context)
- Filtering the documents list from detail view doesn't make sense

```diff
// document-detail-sub-bar.tsx
- import { FilterButton } from '@/components/layout/filter-button'
...
  left={
    <>
-     <FilterButton />
      <ExpandableSearch ... />
    </>
  }
```

**Post-MVP consideration**: Field filtering in document detail view (filter extraction fields, not documents list) - separate feature if needed.

### Task 2.1.2: Create filter pill component
- New file: `frontend/components/layout/filter-pill.tsx`
- Props: `icon`, `label`, `onRemove`
- Custom component (not Badge) - Badge lacks dismiss functionality
- Styling: Match ActionButton (`h-7`, `text-xs`, similar icon sizing)

**Reference implementation:**
```tsx
interface FilterPillProps {
  icon: React.ReactNode
  label: string
  onRemove: () => void
}

export function FilterPill({ icon, label, onRemove }: FilterPillProps) {
  return (
    <span className="inline-flex items-center h-7 pl-2 pr-1 text-xs rounded-md border bg-secondary/50 gap-1">
      <span className="size-3.5 [&>svg]:size-full">{icon}</span>
      {label}
      <button
        onClick={onRemove}
        className="size-5 hover:bg-muted rounded grid place-items-center"
      >
        <Icons.X className="size-3" />
      </button>
    </span>
  )
}
```

**Design decisions:**
- Custom component over Badge (Badge is non-interactive span)
- Lives in `components/layout/` alongside ActionButton
- Matches ActionButton height/text for visual consistency

### Task 2.1.3: ~~Add getAllStacks query~~ SKIPPED

**Status**: Removed - using client-side `useStacks()` hook instead (Task 2.1.7).

Server-side query unnecessary since sub-bar stays as client component with client-side fetch.

### Task 2.1.4: Redesign filter dropdown with sub-menus
- Modify: `frontend/components/layout/filter-button.tsx`
- Match sidebar dropdown styling exactly (`sidebar-header-menu.tsx`)
- Remove status section (cleanup in Task 2.1.1)
- Remove FilterButton from `document-detail-sub-bar.tsx` (cleanup in Task 2.1.1)
- **Add `stacks` prop** to FilterButton

**New interface:**
```tsx
import type { StackSummary } from '@/types/stacks'

interface FilterButtonProps {
  stacks: StackSummary[]
}

export function FilterButton({ stacks }: FilterButtonProps) {
  // ...
}
```

**Pattern reference** (from Theme submenu):
```tsx
<DropdownMenuContent align="start" className="w-52">
  {/* Date sub-menu */}
  <DropdownMenuSub>
    <DropdownMenuSubTrigger>
      <Icons.Calendar className="size-4" />
      <span>Date</span>
    </DropdownMenuSubTrigger>
    <DropdownMenuSubContent>
      <DropdownMenuItem onClick={() => setDateRange('all')}>
        <Icons.Clock className="size-4" />
        <span>All time</span>
        {dateRange === 'all' && <Icons.Check className="ml-auto size-4" />}
      </DropdownMenuItem>
      <DropdownMenuItem onClick={() => setDateRange('today')}>
        <Icons.Calendar className="size-4" />
        <span>Today</span>
        {dateRange === 'today' && <Icons.Check className="ml-auto size-4" />}
      </DropdownMenuItem>
      {/* ... Yesterday, Last 7 days, Last 30 days */}
    </DropdownMenuSubContent>
  </DropdownMenuSub>

  {/* Stacks sub-menu */}
  <DropdownMenuSub>
    <DropdownMenuSubTrigger>
      <Icons.Stack className="size-4" />
      <span>Stacks</span>
    </DropdownMenuSubTrigger>
    <DropdownMenuSubContent>
      {stacks.map((stack) => (
        <DropdownMenuItem key={stack.id} onClick={() => toggleStackFilter(stack.id)}>
          <Icons.Stack className="size-4" />
          <span>{stack.name}</span>
          {stackFilter.has(stack.id) && <Icons.Check className="ml-auto size-4" />}
        </DropdownMenuItem>
      ))}
    </DropdownMenuSubContent>
  </DropdownMenuSub>

  {/* Clear filters (shown when filters active) */}
  {activeFilterCount > 0 && (
    <>
      <DropdownMenuSeparator />
      <DropdownMenuItem onClick={clearFilters} className="text-muted-foreground">
        Clear all filters
      </DropdownMenuItem>
    </>
  )}
</DropdownMenuContent>
```

**Key styling:**
- `className="w-52"` - same width as sidebar dropdown
- Icons: `size-4` for all icons
- Check mark: `<Icons.Check className="ml-auto size-4" />` for selected items
- No checkboxes - use check mark pattern like Theme menu

### Task 2.1.5: Create filter bar component
- New file: `frontend/components/layout/filter-bar.tsx`
- Renders: pills + filter button in flex container
- Search stays separate (not part of FilterBar)

**Layout:**
```
SubBar left:  [FilterBar] [Search]
              └─ [pill] [pill] [≡ Filter]
```

**Reference implementation:**
```tsx
interface FilterBarProps {
  stacks: StackSummary[]  // For FilterButton to render stack options
}

export function FilterBar({ stacks }: FilterBarProps) {
  const { dateRange, stackFilter, clearDateFilter, clearStackFilter } = useDocumentsFilter()

  // Map stack IDs to names for pills
  const stackMap = new Map(stacks.map(s => [s.id, s.name]))

  return (
    <div className="flex items-center gap-2">
      {/* Date pill */}
      {dateRange !== 'all' && (
        <FilterPill
          icon={<Icons.Calendar />}
          label={DATE_LABELS[dateRange]}
          onRemove={clearDateFilter}
        />
      )}

      {/* Stack pills */}
      {Array.from(stackFilter).map((stackId) => (
        <FilterPill
          key={stackId}
          icon={<Icons.Stack />}
          label={stackMap.get(stackId) ?? 'Unknown'}
          onRemove={() => clearStackFilter(stackId)}
        />
      ))}

      {/* Filter dropdown */}
      <FilterButton stacks={stacks} />
    </div>
  )
}
```

**Date label mapping:**
```tsx
const DATE_LABELS: Record<string, string> = {
  today: 'Today',
  yesterday: 'Yesterday',
  last7: '7 days',
  last30: '30 days',
}
```

### Task 2.1.6: Update documents table filtering
- Modify: `frontend/components/documents/documents-table.tsx`
- Replace `statusFilter` logic with `stackFilter` logic
- Documents already have `stacks: StackSummary[]` - no joins needed

**Changes:**

1. Update destructure (line 48):
```diff
- const { filterValue, setSelectedCount, dateRange, statusFilter } = useDocumentsFilter()
+ const { filterValue, setSelectedCount, dateRange, stackFilter } = useDocumentsFilter()
```

2. Replace filter logic (lines 60-63):
```diff
- // Apply status filter (if any selected)
- if (statusFilter.size > 0) {
-   result = result.filter((doc) => statusFilter.has(doc.status))
- }
+ // Apply stack filter (if any selected)
+ if (stackFilter.size > 0) {
+   result = result.filter((doc) =>
+     doc.stacks.some((stack) => stackFilter.has(stack.id))
+   )
+ }
```

3. Update useMemo deps (line 66):
```diff
- }, [documents, dateRange, statusFilter])
+ }, [documents, dateRange, stackFilter])
```

### Task 2.1.7: Wire up in sub-bar
- Keep client component, fetch stacks client-side
- Replace FilterButton with FilterBar

**Approach**: Client-side fetch (simpler than server component split)
- Stacks load after hydration (~100ms)
- Fine for dropdown - not open on page load anyway

**New hook** (`hooks/use-stacks.ts`):
```tsx
'use client'

import { useEffect, useState } from 'react'
import { useSupabase } from '@/hooks/use-supabase'
import type { StackSummary } from '@/types/stacks'

export function useStacks() {
  const [stacks, setStacks] = useState<StackSummary[]>([])
  const [loading, setLoading] = useState(true)
  const supabase = useSupabase()

  useEffect(() => {
    async function fetchStacks() {
      const { data, error } = await supabase
        .from('stacks')
        .select('id, name')
        .eq('status', 'active')
        .order('name', { ascending: true })

      if (!error && data) {
        setStacks(data)
      }
      setLoading(false)
    }
    fetchStacks()
  }, [supabase])

  return { stacks, loading }
}
```

**Note**: Uses existing `useSupabase()` hook (not `createBrowserSupabaseClient` which doesn't exist).

**Updated page** (`@subbar/documents/page.tsx`):
```tsx
'use client'

import { SubBar } from '@/components/layout/sub-bar'
import { FilterBar } from '@/components/layout/filter-bar'
import { ExpandableSearch } from '@/components/layout/expandable-search'
import { SelectionActions } from '@/components/layout/selection-actions'
import { ActionButton } from '@/components/layout/action-button'
import { useAgentStore, initialUploadData } from '@/components/agent'
import { useDocumentsFilter } from '@/components/documents/documents-filter-context'
import { useStacks } from '@/hooks/use-stacks'
import * as Icons from '@/components/icons'

export default function DocumentsSubBar() {
  const { filterValue, setFilterValue, selectedCount } = useDocumentsFilter()
  const { stacks } = useStacks()
  const openFlow = useAgentStore((state) => state.openFlow)

  return (
    <SubBar
      left={
        <>
          <FilterBar stacks={stacks} />
          <ExpandableSearch
            value={filterValue}
            onChange={setFilterValue}
            placeholder="Search documents..."
          />
        </>
      }
      right={
        <>
          <SelectionActions selectedCount={selectedCount} />
          <ActionButton
            icon={<Icons.Upload />}
            onClick={() => openFlow({ type: 'upload', step: 'dropzone', data: initialUploadData })}
          >
            Upload
          </ActionButton>
        </>
      }
    />
  )
}
```

**Key changes:**
- New `useStacks` hook for client-side fetch
- `FilterButton` replaced with `FilterBar`
- Stacks passed to FilterBar (empty initially, populated after fetch)

### Task 2.1.8: Filter-aware empty state
- Modify: `frontend/components/documents/documents-table.tsx`
- Differentiate between "no documents" and "filtered to zero"

**Current** (lines 240-254): Single empty state for all cases

**New logic:**
```tsx
// Add to destructure from context
const { clearFilters, activeFilterCount } = useDocumentsFilter()

// In the empty state section (replace lines 240-254):
) : documents.length === 0 ? (
  // Truly empty - no documents uploaded
  <TableRow className="hover:bg-transparent">
    <TableCell colSpan={columns.length} className="h-48">
      <div className="flex flex-col items-center justify-center text-center py-8">
        <div className="rounded-full bg-muted/50 p-4 mb-4">
          <Icons.FileText className="size-8 text-muted-foreground/60" />
        </div>
        <p className="text-sm font-medium">No documents yet</p>
        <p className="text-xs text-muted-foreground mt-1 max-w-[220px]">
          Upload a document to start extracting data
        </p>
      </div>
    </TableCell>
  </TableRow>
) : (
  // Has documents but filtered to zero
  <TableRow className="hover:bg-transparent">
    <TableCell colSpan={columns.length} className="h-48">
      <div className="flex flex-col items-center justify-center text-center py-8">
        <div className="rounded-full bg-muted/50 p-4 mb-4">
          <Icons.FilterOff className="size-8 text-muted-foreground/60" />
        </div>
        <p className="text-sm font-medium">No documents match your filters</p>
        <p className="text-xs text-muted-foreground mt-1">
          Try adjusting your filters or{' '}
          <button
            onClick={clearFilters}
            className="text-primary underline underline-offset-2 hover:text-primary/80"
          >
            clear all filters
          </button>
        </p>
      </div>
    </TableCell>
  </TableRow>
)}
```

**Key changes:**
- Add `clearFilters` to destructure from context
- Two empty states: truly empty vs filtered to zero
- Different icon: `Icons.FilterOff` for filtered state
- Inline "clear all filters" link button

## Date Label Mapping

| Value | Pill Label |
|-------|------------|
| today | Today |
| yesterday | Yesterday |
| last7 | 7 days |
| last30 | 30 days |
