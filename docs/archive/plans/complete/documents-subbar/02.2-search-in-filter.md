# Phase 2.2: Search in Filter Dropdown

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Move document search from ExpandableSearch into FilterButton dropdown, matching Linear-style UX.

**Architecture:** Search input at top of dropdown, wired to existing `filterValue` context. Search shows as dismissible pill in FilterBar.

**Tech Stack:** shadcn/ui Input, existing DocumentsFilterContext

**IMPORTANT - Design Reference:** The search input styling MUST match `StacksDropdown` (`frontend/components/documents/stacks-dropdown.tsx`). Key patterns:
- Input at top with `h-5 text-sm border-0 shadow-none focus-visible:ring-0 pl-0.5 pr-0`
- Wrapper div with `px-2 py-1`
- `onKeyDown={(e) => e.stopPropagation()}` to prevent dropdown typeahead
- `DropdownMenuSeparator` below search input

---

## Task 9: Add Search Input to FilterButton Dropdown

**Files:**
- Modify: `frontend/components/layout/filter-button.tsx`

**Step 1: Add imports and get filterValue from context**

```tsx
// Add Input import:
import { Input } from '@/components/ui/input'

// Add DropdownMenuSeparator to existing dropdown-menu import:
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,  // Add this
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'

// Add to useDocumentsFilter destructure:
const {
  filterValue,
  setFilterValue,
  dateRange,
  // ... rest
} = useDocumentsFilter()
```

**Step 2: Add search input at top of DropdownMenuContent**

```tsx
<DropdownMenuContent align="start" className="w-52" onCloseAutoFocus={(e) => e.preventDefault()}>
  {/* Search input */}
  <div className="px-2 py-1">
    <Input
      placeholder="Search documents..."
      aria-label="Search documents"
      value={filterValue}
      onChange={(e) => setFilterValue(e.target.value)}
      onKeyDown={(e) => e.stopPropagation()}
      className="h-5 text-sm border-0 shadow-none focus-visible:ring-0 pl-0.5 pr-0"
    />
  </div>
  <DropdownMenuSeparator />

  {/* Date sub-menu */}
  {/* ... rest unchanged */}
</DropdownMenuContent>
```

**Step 3: Verify build**

Run: `cd frontend && npm run build`

**Step 4: Commit**

```bash
git add frontend/components/layout/filter-button.tsx
git commit -m "feat: add search input to FilterButton dropdown"
```

---

## Task 10: Add Search Pill to FilterBar

**Files:**
- Modify: `frontend/components/layout/filter-bar.tsx`

**Step 1: Get filterValue from context**

```tsx
const { dateRange, stackFilter, filterValue, setFilterValue, clearDateFilter, clearStackFilter } = useDocumentsFilter()
```

**Step 2: Add search pill (render before date pill)**

```tsx
return (
  <div className="flex items-center gap-2">
    <FilterButton stacks={stacks} />

    {/* Search pill */}
    {filterValue && (
      <FilterPill
        icon={<Icons.Search className="size-full" />}
        label={`"${filterValue}"`}
        onRemove={() => setFilterValue('')}
      />
    )}

    {/* Date pill */}
    {dateRange !== 'all' && (
      <FilterPill ... />
    )}

    {/* Stack pills */}
    {Array.from(stackFilter).map(...)}
  </div>
)
```

**Step 3: Update context in `documents-filter-context.tsx`**

Update `activeFilterCount` to include search:

```tsx
const activeFilterCount = useMemo(() => {
  let count = 0
  if (filterValue) count += 1  // Add this line
  if (dateRange !== 'all') count += 1
  count += stackFilter.size
  return count
}, [filterValue, dateRange, stackFilter])
```

Update `clearFilters` to also clear search:

```tsx
const clearFilters = useCallback(() => {
  setFilterValueState('')  // Add this line
  setDateRangeState('all')
  setStackFilterState(new Set())
}, [])
```

**Step 4: Verify build**

Run: `cd frontend && npm run build`

**Step 5: Commit**

```bash
git add frontend/components/layout/filter-bar.tsx frontend/components/documents/documents-filter-context.tsx
git commit -m "feat: add search pill to FilterBar"
```

---

## Task 11: Remove ExpandableSearch from SubBar

**Files:**
- Modify: `frontend/app/(app)/@subbar/documents/page.tsx`

**Step 1: Remove ExpandableSearch import and usage**

```tsx
// REMOVE this import:
// import { ExpandableSearch } from '@/components/layout/expandable-search'

// REMOVE from useDocumentsFilter destructure:
// filterValue, setFilterValue (no longer needed in this component)

// REMOVE from SubBar left:
// <ExpandableSearch
//   value={filterValue}
//   onChange={setFilterValue}
//   placeholder="Search documents..."
// />
```

**Step 2: Simplified SubBar**

```tsx
export default function DocumentsSubBar() {
  const { selectedCount } = useDocumentsFilter()
  const { stacks } = useStacks()
  const openFlow = useAgentStore((state) => state.openFlow)

  return (
    <SubBar
      left={<FilterBar stacks={stacks} />}
      right={
        <>
          <SelectionActions selectedCount={selectedCount} />
          <ActionButton
            icon={<Icons.Upload />}
            onClick={() => openFlow({ type: 'upload', step: 'dropzone', data: initialUploadData })}
          >
            Upload
          </ActionButton>
        </>
      }
    />
  )
}
```

**Step 3: Verify build**

Run: `cd frontend && npm run build`

**Step 4: Commit**

```bash
git add frontend/app/(app)/@subbar/documents/page.tsx
git commit -m "refactor: remove ExpandableSearch, search now in FilterButton"
```

---

## Task 12: Cleanup ExpandableSearch

**Files:**
- Potentially delete: `frontend/components/layout/expandable-search.tsx`

**Step 1: Check if ExpandableSearch is used elsewhere**

```bash
grep -r "ExpandableSearch" frontend --include="*.tsx" -l
```

**Step 2: Decide based on results**

- If **only** `@subbar/documents/page.tsx` (removed in Task 11) → Delete component
- If used in other files → Keep component, skip to Task 13

**Step 3: If deleting, remove the file**

```bash
git rm frontend/components/layout/expandable-search.tsx
```

**Step 4: Commit**

```bash
git commit -m "chore: remove unused ExpandableSearch component"
```

---

## Task 13: Add Filter Button to Document Detail SubBar (Search Only)

**Goal:** Add FilterButton to document detail page for searching extracted fields.

**Files:**
- Modify: `frontend/components/documents/document-detail-sub-bar.tsx`

**Step 1: Add required imports**

```tsx
import { Input } from '@/components/ui/input'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { ActionButton } from '@/components/layout/action-button'
import * as Icons from '@/components/icons'
import { FilterPill } from '@/components/layout/filter-pill'
```

**Step 2: Create DetailFilterButton component (above DocumentDetailSubBar)**

```tsx
function DetailFilterButton() {
  const { fieldSearch, setFieldSearch } = useDocumentDetailFilter()

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <ActionButton icon={<Icons.Filter />}>
          {!fieldSearch && 'Filter'}
        </ActionButton>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="start" className="w-52">
        <div className="px-2 py-1">
          <Input
            placeholder="Search fields..."
            aria-label="Search fields"
            value={fieldSearch}
            onChange={(e) => setFieldSearch(e.target.value)}
            onKeyDown={(e) => e.stopPropagation()}
            className="h-5 text-sm border-0 shadow-none focus-visible:ring-0 pl-0.5 pr-0"
          />
        </div>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

**Step 3: Update SubBar left slot**

Remove ExpandableSearch import and usage, add DetailFilterButton with search pill:

```tsx
<SubBar
  left={
    <>
      <DetailFilterButton />
      {fieldSearch && (
        <FilterPill
          icon={<Icons.Search className="size-full" />}
          label={`"${fieldSearch}"`}
          onRemove={() => setFieldSearch('')}
        />
      )}
    </>
  }
  right={/* ... unchanged */}
/>
```

**Step 4: Verify build**

Run: `cd frontend && npm run build`

**Step 5: Commit**

```bash
git add frontend/components/documents/document-detail-sub-bar.tsx
git commit -m "feat: add FilterButton with search to document detail subbar"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 9 | Add search input to FilterButton dropdown | `filter-button.tsx` |
| 10 | Add search pill to FilterBar + update context | `filter-bar.tsx`, `documents-filter-context.tsx` |
| 11 | Remove ExpandableSearch from SubBar | `@subbar/documents/page.tsx` |
| 12 | Cleanup ExpandableSearch (if unused) | `expandable-search.tsx` |
| 13 | Add FilterButton to document detail (search only) | `document-detail-sub-bar.tsx` |

**Result:**
- Documents list: FilterButton with search + date + stacks filters
- Document detail: FilterButton with search only (for fields)
